# Изменения фронтенда для системы множественных ключей

## Обзор изменений

Фронтенд обновлен для поддержки системы множественных ключей с ограничением 1 устройство на ключ.

## Измененные файлы

### 1. Типы (`lib/api/types.ts`)

Добавлены новые поля в `VPNKey`:
- `device_limit_reached?: boolean` - достигнут лимит устройств
- `active_devices_count?: number` - количество активных устройств
- `max_devices?: number` - максимум устройств (обычно 1)
- `limit_message?: string | null` - сообщение об ошибке

Добавлены новые типы:
- `DeviceRegisterRequest` - запрос на регистрацию устройства
- `DeviceRegisterResponse` - ответ при регистрации
- `DeviceInfo` - информация об устройстве
- `DeviceListResponse` - список устройств

### 2. API Конфигурация (`lib/api/config.ts`)

Добавлены новые endpoints:
- `DEVICES_REGISTER: "/api/devices/auto-register"`
- `DEVICES_LIST: "/api/devices/list"`
- `DEVICES_REMOVE: "/api/devices"`

### 3. API Клиент (`lib/api/client.ts`)

Добавлены методы:
- `registerDevice(data: DeviceRegisterRequest)` - регистрация устройства
- `getDevices(clientId?: string)` - получение списка устройств
- `removeDevice(deviceId: string)` - отключение устройства

Обновлена обработка ошибок для правильной передачи статуса и данных ошибки.

### 4. Хук копирования (`hooks/use-clipboard.ts`)

**Ключевое изменение**: При копировании конфига автоматически регистрируется устройство.

- Добавлена функция `getDeviceName()` для определения имени устройства
- `copyToClipboard` теперь асинхронная и вызывает `apiClient.registerDevice()`
- При ошибке 403 (превышен лимит) показывается alert с объяснением

### 5. Компонент карточки ключа (`components/shared/vpn-key-card.tsx`)

Добавлено:
- Предупреждение о лимите устройств (желтый блок)
- Отображение счетчика устройств
- Кнопка "Устройства" для просмотра списка активных устройств
- Интеграция с компонентом `KeyDevicesList`

### 6. Новый компонент (`components/shared/key-devices-list.tsx`)

Компонент для отображения списка устройств для конкретного ключа:
- Показывает активные устройства
- Отображает последнюю активность и трафик
- Позволяет отключить устройство

### 7. Хук данных дашборда (`hooks/use-dashboard-data.ts`)

Обновлен тип `DashboardVPNKey` для поддержки новых полей:
- `device_limit_reached`
- `active_devices_count`
- `max_devices`
- `limit_message`

### 8. Вкладка ключей (`components/shared/dashboard-keys-tab.tsx`)

Добавлено информационное сообщение о лимите устройств.

## Как это работает

### При копировании конфига

1. Пользователь нажимает кнопку копирования
2. Конфиг копируется в буфер обмена
3. **Автоматически** вызывается `apiClient.registerDevice()` с:
   - `client_id` - ID ключа
   - `config_text` - VLESS конфиг
   - `device_name` - автоматически определенное имя устройства
4. Если регистрация успешна - устройство зарегистрировано
5. Если превышен лимит (403) - показывается alert с объяснением

### Отображение ключей

- Каждый ключ отображается в отдельной карточке
- Если достигнут лимит устройств - показывается желтое предупреждение
- Отображается счетчик: "Устройств: 1 / 1"
- Кнопка "Устройства" позволяет посмотреть список активных устройств

### Управление устройствами

- Пользователь может открыть список устройств для каждого ключа
- Видит имя устройства, последнюю активность, трафик
- Может отключить устройство, освободив место для нового

## Важные моменты

1. **Автоматическая регистрация**: Устройство регистрируется автоматически при копировании конфига. Пользователю не нужно делать ничего дополнительно.

2. **Обработка ошибок**: Если превышен лимит, показывается понятное сообщение с объяснением, что нужно купить новый тариф для другого устройства.

3. **Несколько ключей**: Пользователь видит все свои ключи в списке. Каждый ключ работает независимо.

4. **Обновление данных**: После отключения устройства список обновляется автоматически.

## Тестирование

1. **Тест регистрации**: Скопируйте конфиг - устройство должно зарегистрироваться
2. **Тест лимита**: Попробуйте скопировать конфиг второй раз - должно показать ошибку
3. **Тест нескольких ключей**: Купите два тарифа - должны появиться два ключа
4. **Тест отключения**: Отключите устройство - должно освободить место для нового

## Совместимость

Все изменения обратно совместимы. Если бэкенд не вернул новые поля, фронтенд продолжит работать как раньше.
